---
title: "Suicide Data Analysis Project"
author: "Stats Stars"
date: "04/29/19"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Your project goes here! Before you submit, make sure your chunks are turned off with `echo = FALSE`. 

You can add sections as you see fit. Make sure you have a section called Introduction at the beginning and a section called Conclusion at the end. The rest is up to you!

### Introduction

```{r load-data, message=FALSE}
library(tidyverse)
library(broom)
suicides <- read_csv("/cloud/project/data/master.csv")
```


```{r suicides}
suicides <- suicides %>%
  mutate(Year = year,
         Age = age,
         Sex = sex,
         Country = country,
         Generation = generation,
         Population = population,
         suicides_per_100k_pop = `suicides/100k pop`, 
         gdp_for_year = `gdp_for_year ($)`, 
         gdp_per_capita = `gdp_per_capita ($)`,
         HDI_for_year = `HDI for year`,
         country_year = `country-year`) %>%
  filter(year != "2016")
```

```{r relevel-generation-age}
suicides <- suicides %>%
  mutate(Generation = fct_relevel(Generation, "G.I. Generation", "Silent", "Boomers", "Generation X", "Millenials", "Generation Z"))
suicides <- suicides %>%
  mutate(Age = fct_relevel(Age, "5-14 years", "15-24 years", "25-34 years", "35-54 years", "55-74 years", "75+ years"))
```


### Suicides and Location

```{r country-plot, fig.height=12, fig.width=8}
topcountries <- suicides %>%
  group_by(country) %>%
  summarise(n = mean(suicides_per_100k_pop)) %>%
  filter(n!=0) %>%
  arrange(desc(n))

ggplot(data = topcountries, mapping = aes(x = reorder(country,n), y = n)) +
  geom_bar(aes(y = n), stat = "Identity", fill="blue") +
  coord_flip() +
  labs(title = "Suicides per 100k people",
       subtitle = "by country",
       x = "Country",
       y = "Count")
```

```{r highest-rate-by-country}
topcountries %>%
  slice(1:10)
```

```{r extreem}
extreem <- suicides %>%
  filter(country %in% c("Netherlands", "Ukraine"))
```


```{r suicide-happiness}
ggplot(data = extreem, mapping=aes(x = year , y = suicides_per_100k_pop, color = country)) + 
  geom_smooth()  +  
  labs(title = "Number of Suicides/100K Population for Each Year", 
       x = "Year", y = "Number of Suicides/100K Population")
```

### Suicides and Economic Situation over all Time

We wanted to see if there was a correlation between proportion of suicides and the economic situation in each country. The measure of the economic situation in this data set is GDP per capita measured in US$. We thus created a linear model that visualized the number of suicides per 100k of the population versus the GDP per capita. The graph used data from all countries in the dataset and from the years 1980-2015. There are a lot of data points on the graph and they are all quite scattered. When we fit a linear regression to the graph it gave the equation given below the graph and had an r-squared value also shown below the graph. The very low r-squared value and the very weak positive relationship the regression model gave, indicate that there is little, if any, relationship between GDP per capita and the number of suicides per 100k of the population.  

```{r create-dataframe-grouping-data-countryyear}
#aggregated all the suicides/100k pop data per country-year
suicides_grouped <- aggregate(suicides_per_100k_pop ~ country_year, data = suicides, FUN=sum)

#merged data set created with old one to have access to gdp data
suicide_economics <- merge(suicides, suicides_grouped, by.x = "country_year", by.y = "country_year") %>%
  select(country_year, suicides_per_100k_pop.y, gdp_per_capita)
```

```{r vis-suicide-gdp-per-capita}
ggplot(data = suicide_economics, mapping = aes(x = gdp_per_capita, y = suicides_per_100k_pop.y)) + 
  geom_point(size = 0.1, color = "blue") +
  geom_smooth(method = "lm", se = FALSE,
              col = "orange") +
  labs(title = "Suicides per 100k of the population vs. GDP per capita",
       x = "GDP per capita ($)",
       y = "Suicides per 100k of the population")
```

```{r linear-model-suicide-economics}
model_gdp_suicides <- lm(suicides_per_100k_pop.y ~ gdp_per_capita, data = suicide_economics)
tidy(model_gdp_suicides)
glance(model_gdp_suicides)$r.squared
```

Equation for the linear model is: (Suicides per 100k of the population-hat) = (153) + (0.0000243*GDP per capita($)) 

R-squared value is: 1.534907e-05

The intercept of this model is 153. This means that for a country with a GDP per capita ($) the number of suicides per 100k of the population would be expected to be, on average, 153.

The slope of this model is 0.0000243. This means that for every $1 increase in GDP per capita, the number of suicides per 100k of the population is expected to increase, on average, by 0.0000243.

The r-squared is 1.534907e-05. This means that the GDP per capita in US$ explains 0.00153% of variability in the number of suicides per 100k of the population.

### Suicides and Economic Situation in 2015

Because the previous graph showed so much variability in how GDP per capita affected the proportion of suicides, we were curious to see if the relationship would prove to be clearer by focusing on a single time period. We also thought that GDP per capita might be an imperfect statistic in tracking relative economic affluence over a large period of time. For this reason we made the same visualization and linear regression model, but this time only using data from 2015. This model showed a slightly larger positive correlation between increasing GDP per capita ($) and number of suicides per 100k of the population, but the r-squared value was still not high enough to show any significant correlation. 
```{r create-dataframe-grouping-data-countryyear-2015}
suicides_current <- suicides %>%
  filter(Year == "2015")

#aggregated all the suicides/100k pop data per country-year
suicides_grouped_current <- aggregate(suicides_per_100k_pop ~ country_year, data = suicides_current, FUN=sum)

#merged data set created with old one to have access to gdp data
suicide_economics_current <- merge(suicides, suicides_grouped_current, by.x = "country_year", by.y = "country_year") %>%
  select(country_year, suicides_per_100k_pop.y, gdp_per_capita)
```

```{r vis-suicide-gdp-per-capita-2015}
ggplot(data = suicide_economics_current, mapping = aes(x = gdp_per_capita, y = suicides_per_100k_pop.y)) + 
  geom_point(size = 0.5, color = "blue") +
  geom_smooth(method = "lm", se = FALSE,
              col = "orange") +
  labs(title = "Suicides per 100k of the population vs. GDP per capita",
       subtitle = "in 2015",
       x = "GDP per capita ($)",
       y = "Suicides per 100k of the population")
```

```{r linear-model-gdp-2015}
model_gdp_suicides_current <- lm(suicides_per_100k_pop.y ~ gdp_per_capita, data = suicide_economics_current)
tidy(model_gdp_suicides_current)
glance(model_gdp_suicides_current)$r.squared
```
Equation for the linear model is: (Suicides per 100k of the population-hat) = (127) + (2.168189e-04*GDP per capita($)) 

The R-squared value is: 0.003774998

### Suicides and Generation

```{r vis-generation-suicides}
ggplot(data = suicides, mapping = aes(x = Generation, y = suicides_per_100k_pop)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Suicides per 100k of the population vs. Generation",
       x = "Generation",
       y = "Suicides per 100k of the population")
```

### Suicides and Generation in 2015

```{r vis-generation-suicides-current}
suicides_current <- suicides %>%
  filter(Year == "2015")
ggplot(data = suicides_current, mapping = aes(x = Generation, y = suicides_per_100k_pop)) +
  coord_flip() +
  geom_boxplot() +
  labs(title = "Suicides per 100k of the population vs. Generation",
       subtitle = "in 2015",
       x = "Generation",
       y = "Suicides per 100k of the population")
```

### Suicides and Year

Group number of suicides together by year to find number of suicides for each year:

```{r year-suicides}
year_suicides<- suicides %>%
  group_by(Year) %>% 
  summarize(n = sum(suicides_per_100k_pop))
```

Create visualization to represent the number of suicides for each year:

```{r year-suicides-visualization}
ggplot(data = year_suicides, mapping=aes(x = Year, y =  n)) + 
  geom_line()  +  
  labs(title = "Number of Suicides/100K Population for Each Year", 
       x = "Year", y = "Number of Suicides/100K Population")
```

### Suicides and Sex

Group number of suicides/100k population together by sex to find number of suicides/100k population for each sex:

```{r sex-suicide}
suicides_sex <- suicides %>%
  group_by(Sex) %>%
  summarize(n = sum(suicides_per_100k_pop))
```

Create visualization to represent the number of suicides/100k population for each year:

```{r sex-suicides-visualization}
ggplot(data = suicides_sex, mapping=aes(x = Sex, y =  n)) + 
  geom_col() +
  labs(title = "Number of Suicides/100K Population by Sex", 
       x = "Sex", y = "Number of Suicides per 100k Population")
```

Compare number of suicides/100k population for each sex per year:

```{r year-sex-suicides}
year_sex <- suicides %>%
  group_by(Year, Sex) %>% 
  summarize( n = sum(suicides_per_100k_pop))
year_sex
```

Create visualization to represent proportions of gender for number of suicides/100K population by year:

```{r line}
ggplot(year_sex, aes(x = Year, y = n, color = Sex)) +
    geom_line() +
    labs(title = "Changes in Male and Female Suicide Rates Over Time",
         x = "Year", y = "Number of Suicides per 100k People")
```


### Suicides in the United States

Select data for number of suicides in the United States only:

```{r us-data}
suicides_us <- suicides %>%
  filter(country == "United States") %>%
  group_by(Year) %>%
  summarize(n = sum(suicides_per_100k_pop))

suicides_us
```

Create visualization to represent the number of suicides/100k population over time for the US:

```{r us-suicides-over-time}
ggplot(data = suicides_us, mapping=aes(x = Year, y =  n)) + 
  geom_point(color = "orange")  +  
  geom_line(color = "blue") +
  labs(title = "Number of Suicides/100K Population for Each Year in the United States", 
       x = "Year", y = "Number of Suicides/100K Population")
```

### Linear Modeling 

To figure out which variables influence suicides the most, we will be doing a linear regression. 

# ```{r all}
# full_model <- lm(suicides_per_100k_pop ~ Age + Year + Country + Sex +
#                    Generation Population + gdp_for_year + gdp_per_capita +
#                    HDI_for_year + country_year, data = suicides)
# ```
# 
# 
# ```{r select}
# selected_model <- step(full_model, direction = "backward")
# ```


### Shiny App

```{r shinyapp}
ui <- fluidPage(
    
    # Sidebar layout with a input and output definitions
    sidebarLayout(
        
        # Inputs: Select variables to plot
        sidebarPanel(
            
           # Select country
            selectInput(inputId = "country_data",
                      label = "Country",
                      choices = suicides$country,
                      selected = "`Albania`"),
           
            # Select variable for x-axis
            selectInput(inputId = "x", 
                        label = "X-axis:",
                        choices = c("Year", "Sex", "Age", "Generation", "Population", "gdp_for_year",
                                    "gdp_per_capita", "HDI_for_year"),
                        selected = "Year"),
            
            # Select variable for y-axis
            selectInput(inputId = "y", 
                        label = "Y-axis:",
                        choices = c("suicides_no", "suicides_per_100k_pop"), 
                        selected = "suicides_per_100k_pop"),
            
            # Show data table
            checkboxInput(inputId = "show_data",
                          label = "Show Data: ",
                          value = FALSE)
            ),

        # Output
        mainPanel(
            
            # Show plot
            plotOutput(outputId = "plot"),
            
            # Show data table
            DT::dataTableOutput(outputId = "suicidetable")
        )
        
    )
)

# Define server function --------------------------------------------
server <- function(input, output) {
  
    # Create scatterplot object the plotOutput function is expecting
    output$plot <- renderPlot({
      
      if(input$x %in% c("Age", "Sex", "Generation")){
         ggplot(data = subset(suicides, country %in% input$country_data), 
                aes_string(x = input$x, y = input$y)) +
            geom_boxplot()
      }
      
      else{
         ggplot(data = subset(suicides, country %in% input$country_data), 
                aes_string(x = input$x, y = input$y)) +
            geom_smooth()
      }
    })
    
    # Print data table if checked
    output$suicidetable <- DT::renderDataTable(
        if(input$show_data){
            DT::datatable(data = subset(suicides, country %in% input$country_data), 
                          options = list(pageLength = 15), 
                          rownames = FALSE)
        }
    )
}

# Create the Shiny app object ---------------------------------------
shinyApp(ui, server)
```

### Conclusion